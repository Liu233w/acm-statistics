version: '3'

services:

  reverse-proxy:
    image: traefik:2.1.9@sha256:0f877111f469c6843a3e18d181dc2eaeecaca5cf4dfa8538cb534be2e2806ce1
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--entrypoints.web.address=:80"
    ports:
      - ${EXPOSE_PORT}:80
      - ${TRAEFIK_PORT}:8080 # The Web UI (enabled by --api)
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

  frontend:
    image: ${DOCKER_REPO}acm-statistics-frontend${DOCKER_TAG}
    environment:
      - HOST=0.0.0.0
    labels:
      - traefik.http.routers.frontend.rule=PathPrefix(`/`)
      - traefik.http.services.frontend.loadbalancer.server.port=3000

  crawler-api-backend:
    image: ${DOCKER_REPO}acm-statistics-crawler-api-backend${DOCKER_TAG}
    environment:
      - ACM_STATISTICS_CRAWLER_ENV:crawlers:vjudge:crawler_login_user="${VJUDGE_USERNAME}"
      - ACM_STATISTICS_CRAWLER_ENV:crawlers:vjudge:crawler_login_password="${VJUDGE_PASSWORD}"
    labels:
      - traefik.http.routers.crawler-api-backend.rule=PathPrefix(`/api/crawlers/`)
      - traefik.http.services.crawler-api-backend.loadbalancer.server.port=12001

  watchtower:
    image: v2tec/watchtower
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    command: -s "0 */30 * * * *" --cleanup

  backend:
    image: ${DOCKER_REGISTRY-}acm-statistics-backend
    build:
      context: ../backend
