version: '3.4'

services:

  reverse-proxy:
    image: traefik:2.2.0@sha256:14591144dc8a5dc71dea7ac160683f5578bfbc9cf97aeb042270f843c68e0b17
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--entrypoints.web.address=:80"
    ports:
      - ${EXPOSE_PORT}:80
      - ${TRAEFIK_PORT}:8080 # The Web UI (enabled by --api)
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

  frontend:
    image: ${DOCKER_REPO}acm-statistics-frontend${DOCKER_TAG}
    environment:
      - HOST=0.0.0.0
    labels:
      - traefik.http.routers.frontend.rule=PathPrefix(`/`)
      - traefik.http.services.frontend.loadbalancer.server.port=3000

  crawler-api-backend:
    image: ${DOCKER_REPO}acm-statistics-crawler-api-backend${DOCKER_TAG}
    environment:
      - ACM_STATISTICS_CRAWLER_ENV:crawlers:vjudge:crawler_login_user="${VJUDGE_USERNAME}"
      - ACM_STATISTICS_CRAWLER_ENV:crawlers:vjudge:crawler_login_password="${VJUDGE_PASSWORD}"
    labels:
      - traefik.http.routers.crawler-api-backend.rule=PathPrefix(`/api/crawlers/`)
      - traefik.http.services.crawler-api-backend.loadbalancer.server.port=12001

  watchtower:
    image: v2tec/watchtower@sha256:4cb6299fe87dcbfe0f13dcc5a11bf44bd9628a4dae0035fecb8cc2b88ff0fc79
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    command: -s "0 */30 * * * *" --cleanup

  backend:
    image: ${DOCKER_REPO}acm-statistics-backend${DOCKER_TAG}
    environment:
      ConnectionStrings__Default: Server=db; port=3306; Database=acm_statistics; uid=root; pwd=${MYSQL_ROOT_PASSWORD}; Convert Zero Datetime=True
      BACKEND_ADMIN_DEFAULT_PASSWORD: ${BACKEND_ADMIN_DEFAULT_PASSWORD}
      Authentication__JwtBearer__SecurityKey: ${BACKEND_JWT_PRIVATE_KEY}
      WAIT_COMMAND: wait-for-it db:3306 -t 0
    labels:
      - traefik.http.routers.backend.rule=PathPrefix(`/api`)||PathPrefix(`/AntiForgery`)
      - traefik.http.routers.backend.priority=18
      - traefik.http.services.backend.loadbalancer.server.port=80
    volumes:
      - ./App_Data:/app/App_Data
    depends_on:
      - db

  db:
    image: mysql:8@sha256:60adb98682fd8b89b3534624d3bce0b15df6a476f92ba102a2f54b2c353a1544
    restart: always
    environment:
      MYSQL_DATABASE: acm_statistics
      # Password for root access
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
    # Where our data will be persisted
    volumes:
      - ./backend-db:/var/lib/mysql

  captcha-service:
    image: ${DOCKER_REPO}acm-statistics-captcha-service${DOCKER_TAG}
    labels:
      # 只有获取验证码需要从外部访问api，其他部分不需要
      - traefik.http.routers.captcha-service.rule=Path(`/api/captcha-service/generate`)
      - traefik.http.services.captcha-service.loadbalancer.server.port=80

